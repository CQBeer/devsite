title: 总体架构
-----------

## 1、架构图

![总体架构图](index/structure.png)

### 1.1 存储和工具层

#### 1.1.1 工具

​	NULS底层代码中独立了tools-module模块，提供各种底层相关的工具代码，包括密码学工具、http工具、缓存工具、数学计算工具、配置文件操作工具、命令行工具等，便于上层模块使用

#### 1.1.2 存储层

​	db-module模块定义了数据存储服务的接口、用于存储各类型的数据，当前实现的版本基于LevelDB进行key-value式的存储，可以将任意序列化数据存入数据库中，高效、节省空间。

### 1.2 网络层

​	network-module模块定义了网络服务的接口，用于与对等节点建立连接和互相通信。当前实现的版本基于Netty实现，定义了一系列通讯协议，实现节点和连接的管理。模块功能包括节点发现、数据传输、定时握手、节点管理等功能

### 1.3 共识层

​	共识层定义了token，激励机制，区块打包机制，基础数据协议，和核心业务流程，当前实现采用POC共识实现。

### 1.4 接口层

​	NULS的接口层分为两个部分，智能合约和RPC接口服务，智能合约基于NVM运行，支持Java语法。RPC由各个功能模块实现，每个模块可以提供自己的RPC接口，所有RPC接口汇总组成了NULS RPC接口服务。

### 1.5 应用层

​	NULS生态中的业务应用。

## 2、 模块关系

![模块关系](index/relationship.png)

### 2.1 Tools模块

​	工具模块，内置一些基础工具供其他模块使用。

### 2.2 Core模块

​	微内核模块，负责模块的管理，线程的管理，上下文的管理，配置信息的管理。

### 2.3 Account模块

​	账户模块负责地址、公私钥对、账户token余额的管理

### 2.4 Network模块

​	网络模块负责接收和发送对等节点间的消息，其中业务消息会通过接口调用的方式发送给message-bus模块。

### 2.5 Message-Bus模块

​	该模块当前实现使用Disruptor环形队列来进行数据的缓冲，并将消息分发给对应的订阅者（Handlers）。

### 2.6 Protocol模块

​	当前实现的Protocol模块，定义了大部分通用业务的协议，并且实现了大部分协议的处理器，包括区块处理、交易处理，数据同步等内容。

### 2.7 consensus模块

​	共识模块负责token的创建、管理，打包，数据验证，数据存储，区块打包的业务逻辑管理，节点惩罚等内容。

### 2.8 Ledger模块

​	该模块负责存储交易及交易中的token数据记录，验证token使用是否合法。

### 2.9 Storage模块

​	db-module存储模块支持所有类型的数据存储，当前采用LevelDB进行存储。

### 2.10 Contract模块

​	合约模块主要用于与NVM(NULS虚拟机)通讯，可以进行智能合约相关业务的调用、查询操作。

更详细模块介绍参见后续章节

## 3、核心业务关系

![区块链](index/blockchain.png)

说明：

* 系统启动后通过节点发现功能，寻找并连接对等节点，实现节点间通讯。
* 接收到的外部消息统一进入ConnectionManager中处理，如果是网络模块自身的消息，则放入网络消息处理器中，否则统一通过Message-Bus的分发，传入对应消息的处理器中进行处理
* 消息分为3个类型，区块、交易和其他业务消息，处理的方式各有不同
* 交易放入缓冲池，然后进行校验，供共识模块进行打包
* 区块验证后直接进行存储
* 其他业务消息在handler中处理并调用网络返回处理结果
* 应用通过调用RPC来实现数据交互，可以像网络广播一条交易，也可以从收到的区块中获取需要的数据。
* 各个模块调用存储模块时，会把业务数据准备好，存储模块只负责增删改查操作，不进行任何业务处理。